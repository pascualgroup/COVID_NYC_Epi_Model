---
title: Comparison of p_S profile with respect to serology for simulated trajectories
  and observed data
author: "Rahul Subramanian"
date: "11/2/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load_lib}
rm(list = ls())
library(plyr)
library(tidyverse)
library(magrittr)
library(tibble)
library(stringi)
library(pomp)
library(xtable)
#library(panelPomp)
#library(foreach)
#library(iterators)
#library(doRNG)
#library(aakmisc) ## available at https://kingaa.github.io/
stopifnot(packageVersion("pomp")>="2.2")
#stopifnot(packageVersion("panelPomp")>="0.9.1")
#stopifnot(packageVersion("aakmisc")>="0.26.2")
options(
  stringsAsFactors=FALSE,
  keep.source=TRUE,
  encoding="UTF-8"
)
set.seed(407958184)
```

### Load essential libraries and plot themes
```{r}
source("load_libraries_essential.R")
source("rahul_theme.R")
library(zoo)
library(stringr)
```



## Declare model name
```{r}
full_model_name = "NYC_Covid_Model_Hyrbid_Model_1_Pre-Symp_Compartment_Set_b_p_to_0"
model_name = "N_12"
rda_index = 0
rds_index = 0

```

### Declare profile variable
```{r}
profile_var = "b_a"
```

### Load trajectories and observed data used for fitting
```{r}
big_b_a_single_traj_data = read.csv(
  "../Generated_Data/Representative_Simulations/big_b_a_single_sim_traj_data.csv")
head(big_b_a_single_traj_data)
small_b_a_single_traj_data = read.csv(
  "../Generated_Data/Representative_Simulations/small_b_a_single_sim_traj_data.csv")
head(small_b_a_single_traj_data)

Observed_data = read.csv(paste0(
  "../Generated_Data/observed_data_",
  model_name, ".csv"))
head(Observed_data)

```

### Load parameter combinations and likelihoods
```{r}
load(file = paste0(
       "../Generated_Data/Profiles/",
       model_name, "_Model/", profile_var, "_Profile_Sim_Data_Big_b_a_param/", profile_var,
       "_profile_Sim_Data_Big_b_a_param_top_2_LL_all_params_with_antibody_LL.RData"))
head(top_2_LL_end_subset_with_antibody_LL)
Big_b_a_top_2_LL_end_subset_with_antibody_LL =
  top_2_LL_end_subset_with_antibody_LL

load(file = paste0(
       "../Generated_Data/Profiles/",
       model_name, "_Model/", profile_var, "_Profile_Sim_Data_Small_b_a_param/", profile_var,
       "_profile_Sim_Data_Small_b_a_param_top_2_LL_all_params_with_antibody_LL.RData"))
head(top_2_LL_end_subset_with_antibody_LL)
Small_b_a_top_2_LL_end_subset_with_antibody_LL =
  top_2_LL_end_subset_with_antibody_LL


load(file = paste0(
       "../Generated_Data/Profiles/",
       model_name, "_Model/", profile_var, "_Profile/", profile_var,
       "_profile_top_2_LL_all_params_with_antibody_LL.RData"))
head(top_2_LL_end_subset_with_antibody_LL)
Obs_data_top_2_LL_end_subset_with_antibody_LL =
  top_2_LL_end_subset_with_antibody_LL
```

### Combine data
```{r}
### Add identifier label
Big_b_a_top_2_LL_end_subset_with_antibody_LL =
  Big_b_a_top_2_LL_end_subset_with_antibody_LL %>%
  mutate(Fit_To = "Big b_a \n sim") %>%
  mutate(p_S_serology_2LL_thres = max(Antibody_Mean_LL)-2)

Small_b_a_top_2_LL_end_subset_with_antibody_LL =
  Small_b_a_top_2_LL_end_subset_with_antibody_LL %>%
  mutate(Fit_To = "Small b_a \n sim")%>%
  mutate(p_S_serology_2LL_thres = max(Antibody_Mean_LL)-2)

Obs_data_top_2_LL_end_subset_with_antibody_LL =
  Obs_data_top_2_LL_end_subset_with_antibody_LL %>%
  mutate(Fit_To = "Observed \n Data")%>%
  mutate(p_S_serology_2LL_thres = max(Antibody_Mean_LL)-2)

Combined_traj_top_2_LL_end_subset_with_antibody_LL =
  Big_b_a_top_2_LL_end_subset_with_antibody_LL %>%
  rbind(Small_b_a_top_2_LL_end_subset_with_antibody_LL) %>%
  rbind(Obs_data_top_2_LL_end_subset_with_antibody_LL)
head(Combined_traj_top_2_LL_end_subset_with_antibody_LL)

```

### Re-plot p_S vs Antibody LL plot for manuscript
```{r}

p = ggplot(data = Obs_data_top_2_LL_end_subset_with_antibody_LL,
           aes(x = p_S,
               y = Antibody_Mean_LL)) +
  geom_point() +
  rahul_man_figure_theme +
  theme_white_background +
  theme(axis.title.x = element_text(face = "plain"),
        axis.title.y = element_text(face = "plain")) +
  geom_hline(aes(yintercept =
                   p_S_serology_2LL_thres),
             color = 'blue') +
  xlab(expression(paste(
    "Proportion of symptomatic cases (", p[S], ")",))) +
  ylab("Likelihood with respect to serology") 
p
png(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "p_S_vs_Antibody_LL_", model_name,
           "_model_antibody_LL_from_b_a_Profile_Fit_to_Observed_Data.png"))
print(p)
dev.off()

pdf(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "p_S_vs_Antibody_LL_", model_name,
           "_model_antibody_LL_from_b_a_Profile_Fit_to_Observed_Data.pdf"))
print(p)
dev.off()

p = ggplot(data = Obs_data_top_2_LL_end_subset_with_antibody_LL,
           aes(x = p_S,
               y = Antibody_Mean_LL)) +
  geom_point() +
  rahul_man_figure_theme +
  theme_white_background +
  theme(axis.title.x = element_text(face = "plain"),
        axis.title.y = element_text(face = "plain")) +
  geom_hline(aes(yintercept =
                   p_S_serology_2LL_thres),
             color = 'blue') +
  xlab(expression(paste(
    "Proportion of symptomatic cases (", p[S], ")",))) +
  ylab("Likelihood with respect to serology") + 
  xlab("")+
  ylab("")
p

png(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "p_S_vs_Antibody_LL_", model_name,
           "_model_antibody_LL_from_b_a_Profile_Fit_to_Observed_Data_no_labels.png"))
print(p)
dev.off()
```


### Plot p_S vs Antibody LL, color by trajectory used for fitting
```{r}
p = ggplot(data = Combined_traj_top_2_LL_end_subset_with_antibody_LL,
           aes(x = p_S,
               y = Antibody_Mean_LL,
               color = Fit_To)) +
  geom_point() +
  rahul_man_figure_theme +
  theme_white_background +
  theme(axis.title.x = element_text(face = "plain"),
        axis.title.y = element_text(face = "plain")) +
  geom_hline(aes(yintercept =
                   p_S_serology_2LL_thres,
             color = Fit_To)) +
  xlab(expression(paste(
    "Proportion of symptomatic cases (", p[S], ")",))) +
  ylab("Likelihood with respect to serology")  
p

png(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "p_S_vs_Antibody_LL_", model_name,
           "_model_antibody_LL_from_b_a_Profile_comp_of_fit_to_sim_traj_and_obs_data.png"))
print(p)
dev.off()

p = p +
  theme(legend.position = "None")
p
png(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "p_S_vs_Antibody_LL_", model_name,
           "_model_antibody_LL_from_b_a_Profile_comp_of_fit_to_sim_traj_and_obs_data_no_legend.png"))
print(p)
dev.off()

pdf(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "p_S_vs_Antibody_LL_", model_name,
           "_model_antibody_LL_from_b_a_Profile_comp_of_fit_to_sim_traj_and_obs_data_no_legend.pdf"))
print(p)
dev.off()


p = ggplot(data = Combined_traj_top_2_LL_end_subset_with_antibody_LL,
           aes(x = p_S,
               y = Antibody_Mean_LL,
               color = Fit_To)) +
  geom_point() +
  rahul_man_figure_theme +
  theme_white_background +
  theme(axis.title.x = element_text(face = "plain"),
        axis.title.y = element_text(face = "plain")) +
  geom_hline(aes(yintercept =
                   p_S_serology_2LL_thres,
             color = Fit_To)) +
  xlab(expression(paste(
    "Proportion of symptomatic cases (", p[S], ")",))) +
  ylab("Likelihood with respect to serology") + 
  xlab("")+
  ylab("") +
  theme(legend.position = "None")
p
png(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "p_S_vs_Antibody_LL_", model_name,
           "_model_antibody_LL_from_b_a_Profile_comp_of_fit_to_sim_traj_and_obs_data_no_labels_or_legend.png"))
print(p)
dev.off()

pdf(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "p_S_vs_Antibody_LL_", model_name,
           "_model_antibody_LL_from_b_a_Profile_comp_of_fit_to_sim_traj_and_obs_data_no_labels_or_legend.pdf"))
print(p)
dev.off()
```


### Zoom in
```{r}
ylim_thres = min(Combined_traj_top_2_LL_end_subset_with_antibody_LL$p_S_serology_2LL_thres) - 20
ylim_thres
Combined_traj_top_2_LL_end_subset_with_antibody_LL_within_20_LL =
  Combined_traj_top_2_LL_end_subset_with_antibody_LL %>%
  filter(Antibody_Mean_LL > p_S_serology_2LL_thres -18)
p = ggplot(data = Combined_traj_top_2_LL_end_subset_with_antibody_LL_within_20_LL,
           aes(x = p_S,
               y = Antibody_Mean_LL,
               color = Fit_To)) +
  geom_point() +
  rahul_man_figure_theme +
  theme_white_background +
  theme(axis.title.x = element_text(face = "plain"),
        axis.title.y = element_text(face = "plain")) +
  geom_hline(aes(yintercept =
                   p_S_serology_2LL_thres,
             color = Fit_To)) +
  xlab(expression(paste(
    "Proportion of symptomatic cases (", p[S], ")",))) +
  ylab("Likelihood with respect to serology") 
p

png(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "p_S_vs_Antibody_LL_", model_name,
           "_model_antibody_LL_from_b_a_Profile_comp_of_fit_to_sim_traj_and_obs_data_ylim_20_LL_bounds.png"))
print(p)
dev.off()

pdf(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "p_S_vs_Antibody_LL_", model_name,
           "_model_antibody_LL_from_b_a_Profile_comp_of_fit_to_sim_traj_and_obs_data_ylim_20_LL_bounds.pdf"))
print(p)
dev.off()

p = p +
  theme(legend.position = "None")
p
png(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "p_S_vs_Antibody_LL_", model_name,
           "_model_antibody_LL_from_b_a_Profile_comp_of_fit_to_sim_traj_and_obs_data_no_legend_ylim_20_LL_bounds.png"))
print(p)
dev.off()

pdf(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "p_S_vs_Antibody_LL_", model_name,
           "_model_antibody_LL_from_b_a_Profile_comp_of_fit_to_sim_traj_and_obs_data_no_legend_ylim_20_LL_bounds.pdf"))
print(p)
dev.off()


p = ggplot(data = Combined_traj_top_2_LL_end_subset_with_antibody_LL_within_20_LL,
           aes(x = p_S,
               y = Antibody_Mean_LL,
               color = Fit_To)) +
  geom_point() +
  rahul_man_figure_theme +
  theme_white_background +
  theme(axis.title.x = element_text(face = "plain"),
        axis.title.y = element_text(face = "plain")) +
  geom_hline(aes(yintercept =
                   p_S_serology_2LL_thres,
             color = Fit_To)) +
  xlab(expression(paste(
    "Proportion of symptomatic cases (", p[S], ")",))) +
  ylab("Likelihood with respect to serology") + 
  xlab("")+
  ylab("") +
  theme(legend.position = "None")
p
png(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "p_S_vs_Antibody_LL_", model_name,
           "_model_antibody_LL_from_b_a_Profile_comp_of_fit_to_sim_traj_and_obs_data_no_labels_or_legend_ylim_20_LL_bounds.png"))
print(p)
dev.off()

pdf(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "p_S_vs_Antibody_LL_", model_name,
           "_model_antibody_LL_from_b_a_Profile_comp_of_fit_to_sim_traj_and_obs_data_no_labels_or_legend_ylim_20_LL_bounds.pdf"))
print(p)
dev.off()

```

## Plot of data and trajectories used for fitting
### Combine datasets
```{r}
big_b_a_single_traj_data =
  big_b_a_single_traj_data %>%
  mutate(Type = "big b_a \n sim")

small_b_a_single_traj_data  = 
  small_b_a_single_traj_data %>%
  mutate(Type = "small b_a \n sim")

Observed_data = 
  Observed_data %>%
  mutate(Type = "Observed \n Data")

Combined_fitting_data =
  big_b_a_single_traj_data %>%
  rbind(small_b_a_single_traj_data) %>%
  rbind(Observed_data)

```

### Plot
```{r}
p = ggplot(data = Combined_fitting_data,
           aes(x = times,
               y = Y,
               color = Type)) +
  geom_point() + geom_line(aes(group = Type)) +
  rahul_man_figure_theme + theme_white_background+
  theme(axis.title.x = element_text(face = "plain"),
        axis.title.y = element_text(face = "plain")) +
  xlab("Days since March 1, 2020") +
  ylab("Daily cases")
p
png(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "comparison_of_observed_data_and_sim_trajectories_used_for_fitting.png"))
print(p)
dev.off()

pdf(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "comparison_of_observed_data_and_sim_trajectories_used_for_fitting.pdf"))
print(p)
dev.off()


p = ggplot(data = Combined_fitting_data,
           aes(x = times,
               y = Y,
               color = Type)) +
  geom_point() + geom_line(aes(group = Type)) +
  rahul_man_figure_theme + theme_white_background +
  theme(legend.position = "None")+
  theme(axis.title.x = element_text(face = "plain"),
        axis.title.y = element_text(face = "plain")) +
  xlab("Days since March 1, 2020") +
  ylab("Daily cases")
p
png(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "comparison_of_observed_data_and_sim_trajectories_used_for_fitting_no_legend.png"))
print(p)
dev.off()

pdf(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "comparison_of_observed_data_and_sim_trajectories_used_for_fitting_no_legend.pdf"))
print(p)
dev.off()


p = ggplot(data = Combined_fitting_data,
           aes(x = times,
               y = Y,
               color = Type)) +
  geom_point() + geom_line(aes(group = Type)) +
  rahul_man_figure_theme + theme_white_background +
  theme(legend.position = "None")+
  xlab("") +
  ylab("")+
  theme(axis.title.x = element_text(face = "plain"),
        axis.title.y = element_text(face = "plain")) +
  xlab("Days since March 1, 2020") +
  ylab("Daily cases")
p
png(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "comparison_of_observed_data_and_sim_trajectories_used_for_fitting_no_legend_or_labels.png"))
print(p)
dev.off()

pdf(paste0("../Figures/Profiles/", model_name, "_Model/Man_Figs_Revision/",
           "comparison_of_observed_data_and_sim_trajectories_used_for_fitting_no_legend_or_labels.pdf"))
print(p)
dev.off()




```

